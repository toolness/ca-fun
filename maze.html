<!DOCTYPE html>
<meta charset="utf-8">
<title>Maze Fun</title>
<h1>Maze Fun</h1>
<script src="vendor/p5.js"></script>
<script>
var WIDTH = 16;
var CELL_WIDTH = 16;
var OPPOSITES = {
  left: 'right',
  right: 'left',
  top: 'bottom',
  bottom: 'top'
};

var cells = [];
var mazeBuilder;

function MazeBuilder(cells) {
  var path = [cells[0][0]];

  return {
    // This is based on the DFS algorithm described in
    // https://en.wikipedia.org/wiki/Maze_generation_algorithm.
    buildOne: function() {
      if (path.length == 0) return false;

      var latest = path[path.length - 1];
      var x = latest.x;
      var y = latest.y;
      var unvisitedDirs = [];

      if (x > 0 && !cells[x - 1][y].visited)
        unvisitedDirs.push('left');
      if (x < WIDTH - 1 && !cells[x + 1][y].visited)
        unvisitedDirs.push('right');
      if (y > 0 && !cells[x][y - 1].visited) 
        unvisitedDirs.push('top');
      if (y < WIDTH - 1 && !cells[x][y + 1].visited) 
        unvisitedDirs.push('bottom');

      if (unvisitedDirs.length == 0) {
        path.pop();
        return this.buildOne();
      }

      var dirIndex = Math.floor(random(0, unvisitedDirs.length));
      var direction = unvisitedDirs[dirIndex];
      var next;

      if (direction == 'left') {
        next = cells[x - 1][y];
      } else if (direction == 'right') {
        next = cells[x + 1][y];
      } else if (direction == 'top') {
        next = cells[x][y - 1];
      } else if (direction == 'bottom') {
        next = cells[x][y + 1];
      }

      latest[direction] = false;
      next[OPPOSITES[direction]] = false;
      next.visited = true;
      path.push(next);

      return true;
    }
  };
}

function setup() {
  createCanvas(WIDTH * CELL_WIDTH + 1, WIDTH * CELL_WIDTH + 1);

  for (var i = 0; i < WIDTH; i++) {
    cells.push([]);
    for (var j = 0; j < WIDTH; j++) {
      cells[i].push({
        x: i,
        y: j,
        top: true,
        left: true,
        bottom: true,
        right: true,
        visited: false
      });
    }
  }

  mazeBuilder = MazeBuilder(cells);
}

function draw() {
  background("black");
  stroke("white");

  for (var i = 0; i < WIDTH; i++) {
    for (var j = 0; j < WIDTH; j++) {
      var cell = cells[i][j];
      if (cell.top) {
        line(i * CELL_WIDTH,
             j * CELL_WIDTH,
             (i + 1) * CELL_WIDTH,
             j * CELL_WIDTH);
      }
      if (cell.bottom) {
        line(i * CELL_WIDTH,
             (j + 1) * CELL_WIDTH,
             (i + 1) * CELL_WIDTH,
             (j + 1) * CELL_WIDTH);
      }
      if (cell.left) {
        line(i * CELL_WIDTH,
             j * CELL_WIDTH,
             i * CELL_WIDTH,
             (j + 1) * CELL_WIDTH);
      }
      if (cell.right) {
        line((i + 1) * CELL_WIDTH,
             j * CELL_WIDTH,
             (i + 1) * CELL_WIDTH,
             (j + 1) * CELL_WIDTH);
      }
    }
  }

  if (!mazeBuilder.buildOne()) noLoop();
}
</script>
